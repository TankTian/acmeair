inputs:
  AK:
    description: 租户ak
    label: huaweiair
  SK:
    description: 租户sk
    label: huaweiair
  appId:
    default: acmeair
    description: 默认应用名称
    label: huaweiair
  booking_image:
    default: '100.125.0.198:20202/servicestage/huaweiair-booking-service:1.0.0-m1-01'
    description: booking服务镜像地址
    label: huaweiair
  booking_name:
    default: huaweiair-booking
    description: booking服务名称
    label: huaweiair
  customer_image:
    default: '100.125.0.198:20202/servicestage/huaweiair-customer-service:1.0.0-m1-01'
    description: customer服务镜像地址
    label: huaweiair
  customer_name:
    default: huaweiair-customer
    description: customer服务名称
    label: huaweiair
  mongo_image:
    default: '100.125.0.198:20202/servicestage/mongo:1.0.0'
    description: mongodb镜像地址
    label: mongodb
  mongo_name:
    default: mongodb
    description: mongodb服务名称
    label: mongodb
  mongo_port:
    default: 32717
    description: mongodb对外暴露访问端口
    label: mongodb
    type: integer
  website_image:
    default: '100.125.0.198:20202/servicestage/huaweiair-website:1.0.0-m1-01'
    description: wwebsite服务镜像地址
    label: huaweiair
  website_name:
    default: huaweiair-website
    description: website服务名称
    label: huaweiair
  website_port:
    default: 30100
    description: website服务对外暴露访问端口
    label: huaweiair
    type: integer
metadata:
  Designer:
    4cc6d116-ee2c-44ab-b88a-2c7bc7022766:
      size:
        width: 60
        height: 60
      position:
        x: 230
        y: 110
      z: 1
      dependson:
        - 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
        - f4b5614f-4ee5-44a6-a1bb-03d76f981892
    6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7:
      size:
        width: 60
        height: 60
      position:
        x: 110
        y: 30
      z: 1
      dependson:
        - f941b656-a0a1-41b4-a6de-3533427acbc7
    e3b32c8b-3970-47f9-b298-991fda2a1499:
      size:
        width: 60
        height: 60
      position:
        x: 230
        y: 210
      z: 1
      dependson:
        - f4b5614f-4ee5-44a6-a1bb-03d76f981892
        - 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
    e5d7b724-a065-4684-be1c-49994270db82:
      size:
        width: 60
        height: 60
      position:
        x: 110
        y: 290
      z: 1
      dependson:
        - eb7f2925-4a36-4612-9cab-379154e7f0b9
    eb7f2925-4a36-4612-9cab-379154e7f0b9:
      size:
        width: 60
        height: 60
      position:
        x: 230
        y: 290
      z: 1
      dependson:
        - f4b5614f-4ee5-44a6-a1bb-03d76f981892
    f4b5614f-4ee5-44a6-a1bb-03d76f981892:
      size:
        width: 60
        height: 60
      position:
        x: 110
        y: 110
      z: 1
    f941b656-a0a1-41b4-a6de-3533427acbc7:
      size:
        width: 60
        height: 60
      position:
        x: 230
        y: 30
      z: 1
      dependson:
        - f4b5614f-4ee5-44a6-a1bb-03d76f981892
    7dfbf088-08f3-4c84-b9af-0e276cbee3b9:
      size:
        width: 60
        height: 60
      position:
        x: 360
        y: 160
      z: 1
      policy:
        - f941b656-a0a1-41b4-a6de-3533427acbc7
        - 4cc6d116-ee2c-44ab-b88a-2c7bc7022766
        - e3b32c8b-3970-47f9-b298-991fda2a1499
        - eb7f2925-4a36-4612-9cab-379154e7f0b9
    763188bc-0d3a-49f5-b08d-64ecc37507b6:
      source:
        id: eb7f2925-4a36-4612-9cab-379154e7f0b9
      target:
        id: f4b5614f-4ee5-44a6-a1bb-03d76f981892
      z: 1
    7f3c1847-e1f2-4414-a34f-1a7903c1bad5:
      source:
        id: e5d7b724-a065-4684-be1c-49994270db82
      target:
        id: eb7f2925-4a36-4612-9cab-379154e7f0b9
      z: 1
    473cb0e9-d272-40a8-b3c5-0c5fbcf0e7c4:
      source:
        id: f941b656-a0a1-41b4-a6de-3533427acbc7
      target:
        id: f4b5614f-4ee5-44a6-a1bb-03d76f981892
      z: 1
    09f40c7c-7748-4730-a049-6ed4b63d1bbe:
      source:
        id: 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
      target:
        id: f941b656-a0a1-41b4-a6de-3533427acbc7
      z: 1
    822de608-7316-48f9-b287-613e4b6c39df:
      source:
        id: 4cc6d116-ee2c-44ab-b88a-2c7bc7022766
      target:
        id: f4b5614f-4ee5-44a6-a1bb-03d76f981892
      z: 1
    a908e341-32ba-449c-963b-327548b9a5b8:
      source:
        id: 4cc6d116-ee2c-44ab-b88a-2c7bc7022766
      target:
        id: 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
      z: 1
    2bb58751-385f-4b7e-8f97-c44bbbc8e8f8:
      source:
        id: e3b32c8b-3970-47f9-b298-991fda2a1499
      target:
        id: f4b5614f-4ee5-44a6-a1bb-03d76f981892
      z: 1
    45e6722c-3603-4713-9f3b-5a8e9ad53702:
      source:
        id: e3b32c8b-3970-47f9-b298-991fda2a1499
      target:
        id: 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
      z: 1
    0b07043c-4b37-4fab-89f1-660b8c6afb45:
      source:
        id: 7dfbf088-08f3-4c84-b9af-0e276cbee3b9
      target:
        id: f941b656-a0a1-41b4-a6de-3533427acbc7
      z: 1
    4a6244af-1a5f-4f83-9b6c-f30704972728:
      source:
        id: 7dfbf088-08f3-4c84-b9af-0e276cbee3b9
      target:
        id: 4cc6d116-ee2c-44ab-b88a-2c7bc7022766
      z: 1
    5272029d-f8d9-45eb-9d50-c9e1aeb1633b:
      source:
        id: 7dfbf088-08f3-4c84-b9af-0e276cbee3b9
      target:
        id: e3b32c8b-3970-47f9-b298-991fda2a1499
      z: 1
    2fdf8605-d13c-43f6-a38b-e727d9d7c879:
      source:
        id: 7dfbf088-08f3-4c84-b9af-0e276cbee3b9
      target:
        id: eb7f2925-4a36-4612-9cab-379154e7f0b9
      z: 1
  relationships:
    4cc6d116-ee2c-44ab-b88a-2c7bc7022766:
      references:
        dependency:
          - get_reference: huaweiair-config
          - get_reference: mongo-service
    6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7:
      references:
        dependency:
          - get_reference: mongo
    e3b32c8b-3970-47f9-b298-991fda2a1499:
      references:
        dependency:
          - get_reference: huaweiair-config
          - get_reference: mongo-service
    e5d7b724-a065-4684-be1c-49994270db82:
      references:
        dependency:
          - get_reference: website
    eb7f2925-4a36-4612-9cab-379154e7f0b9:
      references:
        dependency:
          - get_reference: huaweiair-config
    f941b656-a0a1-41b4-a6de-3533427acbc7:
      references:
        dependency:
          get_reference: huaweiair-config
    7dfbf088-08f3-4c84-b9af-0e276cbee3b9:
      references:
        targets:
          - mongo
          - customer
          - booking
          - website
node_templates:
  booking:
    metadata:
      Designer:
        id: e3b32c8b-3970-47f9-b298-991fda2a1499
    properties:
      k8sManifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app:
              get_input: booking_name
          name:
            get_input: booking_name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: booking_name
          template:
            metadata:
              labels:
                app:
                  get_input: booking_name
            spec:
              containers:
                - env:
                    - name: AK
                      valueFrom:
                        configMapKeyRef:
                          key: ak
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: SK
                      valueFrom:
                        configMapKeyRef:
                          key: sk
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: JAR_NAME
                      value: acmeair-booking-service
                    - name: JAVA_OPTS
                      valueFrom:
                        configMapKeyRef:
                          key: java_opts
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                  image:
                    get_input: booking_image
                  name: booking-container
              imagePullSecrets:
                - name: default-secret
    requirements:
      - dependency:
          node: huaweiair-config
      - dependency:
          node: mongo-service
    type: HuaweiCloud.CCE.Deployment
  customer:
    metadata:
      Designer:
        id: 4cc6d116-ee2c-44ab-b88a-2c7bc7022766
    properties:
      k8sManifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app:
              get_input: customer_name
          name:
            get_input: customer_name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: customer_name
          template:
            metadata:
              labels:
                app:
                  get_input: customer_name
            spec:
              containers:
                - env:
                    - name: AK
                      valueFrom:
                        configMapKeyRef:
                          key: ak
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: SK
                      valueFrom:
                        configMapKeyRef:
                          key: sk
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: JAR_NAME
                      value: acmeair-customer-service
                    - name: JAVA_OPTS
                      valueFrom:
                        configMapKeyRef:
                          key: java_opts
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                  image:
                    get_input: customer_image
                  name: customer-container
              imagePullSecrets:
                - name: default-secret
    requirements:
      - dependency:
          node: huaweiair-config
      - dependency:
          node: mongo-service
    type: HuaweiCloud.CCE.Deployment
  huaweiair-config:
    metadata:
      Designer:
        id: f4b5614f-4ee5-44a6-a1bb-03d76f981892
    properties:
      data:
        ak:
          concat:
            - '-DAPPLICATION_ID='
            - get_input: appId
            - ' -Dcse.credentials.accessKey='
            - get_input: AK
        java_opts:
          concat:
            - '-Dspring.profiles.active=mongodb '
            - '-Dspring.data.mongodb.host=mongodb '
            - '-Dspring.data.mongodb.port='
            - get_input: mongo_port
        sk:
          concat:
            - '-Dcse.credentials.secretKey='
            - get_input: SK
    type: HuaweiCloud.CCE.ConfigMap
  mongo:
    metadata:
      Designer:
        id: f941b656-a0a1-41b4-a6de-3533427acbc7
    properties:
      k8sManifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app:
              get_input: mongo_name
          name:
            get_input: mongo_name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: mongo_name
          template:
            metadata:
              labels:
                app:
                  get_input: mongo_name
            spec:
              containers:
                - image:
                    get_input: mongo_image
                  name: mongo-container
              imagePullSecrets:
                - name: default-secret
    requirements:
      - dependency:
          node: huaweiair-config
    type: HuaweiCloud.CCE.Deployment
  mongo-service:
    metadata:
      Designer:
        id: 6c6bb9f7-24b5-4a11-87cb-8bfbff9764a7
    properties:
      k8sManifest:
        apiVersion: v1
        kind: Service
        metadata:
          labels:
            app:
              get_input: mongo_name
          name:
            get_input: mongo_name
        spec:
          ports:
            - name: mongodb
              port: 32717
              protocol: TCP
              targetPort: 27017
          selector:
            app:
              get_input: mongo_name
          type: ClusterIP
    requirements:
      - dependency:
          node: mongo
    type: HuaweiCloud.CCE.Service
  website:
    metadata:
      Designer:
        id: eb7f2925-4a36-4612-9cab-379154e7f0b9
    properties:
      k8sManifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app:
              get_input: website_name
          name:
            get_input: website_name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: website_name
          template:
            metadata:
              labels:
                app:
                  get_input: website_name
            spec:
              containers:
                - env:
                    - name: AK
                      valueFrom:
                        configMapKeyRef:
                          key: ak
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: SK
                      valueFrom:
                        configMapKeyRef:
                          key: sk
                          name:
                            get_attribute:
                              - huaweiair-config
                              - refName
                    - name: JAR_NAME
                      value: acmeair-webapp
                    - name: JAVA_OPTS
                      value: '-Dspring.profiles.active=sc'
                  image:
                    get_input: website_image
                  name: website-container
                  ports:
                    - containerPort: 8080
                      protocol: TCP
              imagePullSecrets:
                - name: default-secret
    requirements:
      - dependency:
          node: huaweiair-config
    type: HuaweiCloud.CCE.Deployment
  website-service:
    metadata:
      Designer:
        id: e5d7b724-a065-4684-be1c-49994270db82
    properties:
      k8sManifest:
        apiVersion: v1
        kind: Service
        metadata:
          labels:
            app:
              get_input: website_name
          name:
            get_input: website_name
        spec:
          ports:
            - name:
                get_input: website_name
              nodePort:
                get_input: website_port
              port: 8080
              protocol: TCP
              targetPort: 8080
          selector:
            app:
              get_input: website_name
          type: NodePort
    requirements:
      - dependency:
          node: website
    type: HuaweiCloud.CCE.Service
outputs: {}
tosca_definitions_version: huaweicloud_tosca_version_1_0
policies:
  huaweiair-apm:
    type: HuaweiCloud.APM.Pinpoint
    properties:
      name:
        get_input: HuaweiCloud.StackName
    metadata:
      Designer:
        id: 7dfbf088-08f3-4c84-b9af-0e276cbee3b9
    targets:
      - mongo
      - customer
      - booking
      - website
